// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// bmad 研学产品预订平台 - 数据模型定义
// 数据库设计文档: database-design.md

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// 枚举类型定义
// ============================================

enum Role {
  PARENT
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  UNPUBLISHED
}

enum OrderStatus {
  PENDING
  PAID
  CANCELLED
  COMPLETED
  REFUNDED
}

enum RefundStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSING
  COMPLETED
  FAILED
}

enum IssueType {
  COMPLAINT
  QUESTION
  SUGGESTION
  REFUND_REQUEST
}

enum IssueStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum IssuePriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum CouponType {
  PERCENT
  AMOUNT
}

enum CouponStatus {
  ACTIVE
  EXPIRED
  DISABLED
}

enum UserCouponStatus {
  AVAILABLE
  USED
  EXPIRED
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// 核心数据模型
// ============================================

// 1. 用户表 (users)
model User {
  id        Int       @id @default(autoincrement())
  openid    String?   @unique @map("openid")
  email     String?   @unique @map("email")
  nickname  String?   @map("nickname")
  avatarUrl String?   @map("avatar_url")
  phone     String?   @map("phone")
  role      Role      @default(PARENT) @map("role")
  status    UserStatus @default(ACTIVE) @map("status")
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // 关联关系
  orders      Order[]      @relation("UserOrders")
  refunds     Refund[]     @relation("UserRefunds")
  userIssues  UserIssue[]  @relation("UserIssues")
  userCoupons UserCoupon[] @relation("UserCoupons")
  reviews     Review[]     @relation("UserReviews")

  @@index([status])
  @@map("users")
}

// 2. 产品分类表 (product_categories)
model ProductCategory {
  id          Int      @id @default(autoincrement())
  name        String   @map("name")
  description String?  @map("description")
  sortOrder   Int      @default(0) @map("sort_order")
  createdAt   DateTime @default(now()) @map("created_at")

  // 关联关系
  products Product[] @relation("CategoryProducts")
  banners  Banner[]   @relation("BannerCategories")

  @@map("product_categories")
}

// 3. 产品表 (products)
model Product {
  id            Int           @id @default(autoincrement())
  title         String        @map("title")
  description   String        @db.Text @map("description")
  categoryId    Int           @map("category_id")
  price         Decimal       @db.Decimal(10, 2) @map("price")
  originalPrice Decimal?      @db.Decimal(10, 2) @map("original_price")
  stock         Int           @default(0) @map("stock")
  minAge        Int           @default(3) @map("min_age")
  maxAge        Int           @default(18) @map("max_age")
  duration      String        @map("duration")
  location      String        @map("location")
  images        String[]      @map("images")
  status        ProductStatus @default(DRAFT) @map("status")
  featured      Boolean       @default(false) @map("featured")
  viewCount     Int           @default(0) @map("view_count")
  bookingCount  Int           @default(0) @map("booking_count")
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  // 关联关系
  category ProductCategory @relation("CategoryProducts", fields: [categoryId], references: [id])
  orders   Order[]          @relation("ProductOrders")
  reviews  Review[]         @relation("ProductReviews")
  banners  Banner[]         @relation("BannerProducts")

  @@index([categoryId])
  @@index([status])
  @@index([featured])
  @@map("products")
}

// 4. 订单表 (orders)
model Order {
  id              Int        @id @default(autoincrement())
  orderNo         String     @unique @map("order_no")
  userId          Int        @map("user_id")
  productId       Int        @map("product_id")
  status          OrderStatus @default(PENDING) @map("status")
  totalAmount     Decimal    @db.Decimal(10, 2) @map("total_amount")
  paidAmount      Decimal    @default(0) @db.Decimal(10, 2) @map("paid_amount")
  childName       String     @map("child_name")
  childAge        Int        @map("child_age")
  contactPhone    String     @map("contact_phone")
  contactName     String     @map("contact_name")
  bookingDate     DateTime  @map("booking_date")
  participantCount Int       @default(1) @map("participant_count")
  remark          String?    @db.Text @map("remark")
  paidAt          DateTime?  @map("paid_at")
  cancelledAt     DateTime?  @map("cancelled_at")
  completedAt     DateTime?  @map("completed_at")
  reminderSent    Boolean    @default(false) @map("reminder_sent")
  reminderSentAt  DateTime?  @map("reminder_sent_at")
  createdAt       DateTime   @default(now()) @map("created_at")
  updatedAt       DateTime   @updatedAt @map("updated_at")

  // 关联关系
  user    User          @relation("UserOrders", fields: [userId], references: [id])
  product Product       @relation("ProductOrders", fields: [productId], references: [id])
  refunds Refund[]       @relation("OrderRefunds")
  coupons  OrderCoupon[] @relation("OrderCoupons")
  reviews  Review[]      @relation("OrderReview")

  @@index([userId])
  @@index([productId])
  @@index([status])
  @@index([orderNo])
  @@map("orders")
}

// 5. 退款表 (refunds)
model Refund {
  id              Int          @id @default(autoincrement())
  refundNo        String       @unique @map("refund_no")
  orderId         Int          @map("order_id")
  userId          Int          @map("user_id")
  status          RefundStatus @default(PENDING) @map("status")
  refundAmount    Decimal      @db.Decimal(10, 2) @map("refund_amount")
  reason          String       @db.Text @map("reason")
  description     String?      @db.Text @map("description")
  images          String[]     @map("images")
  adminNote       String?      @db.Text @map("admin_note")
  rejectedReason  String?      @db.Text @map("rejected_reason")
  wechatRefundId  String?      @map("wechat_refund_id")
  appliedAt       DateTime     @default(now()) @map("applied_at")
  approvedAt      DateTime?    @map("approved_at")
  rejectedAt      DateTime?    @map("rejected_at")
  completedAt     DateTime?    @map("completed_at")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")

  // 关联关系
  order Order @relation("OrderRefunds", fields: [orderId], references: [id])
  user  User  @relation("UserRefunds", fields: [userId], references: [id])

  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@map("refunds")
}

// 6. 用户问题表 (user_issues)
model UserIssue {
  id          Int          @id @default(autoincrement())
  userId      Int          @map("user_id")
  orderId     Int?         @map("order_id")
  type        IssueType    @map("type")
  title       String       @map("title")
  description String       @db.Text @map("description")
  status      IssueStatus  @default(OPEN) @map("status")
  priority    IssuePriority @default(MEDIUM) @map("priority")
  assignedTo  Int?         @map("assigned_to")
  resolution  String?      @db.Text @map("resolution")
  resolvedAt  DateTime?    @map("resolved_at")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  // 关联关系
  user User @relation("UserIssues", fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@map("user_issues")
}

// 7. 优惠券表 (coupons)
model Coupon {
  id            Int               @id @default(autoincrement())
  name          String            @map("name")
  description   String?           @db.Text @map("description")
  type          CouponType        @map("type")
  value         Decimal           @db.Decimal(10, 2) @map("value")
  minAmount     Decimal?          @db.Decimal(10, 2) @map("min_amount")
  maxDiscount   Decimal?          @db.Decimal(10, 2) @map("max_discount")
  totalQuantity Int               @map("total_quantity")
  claimedQuantity Int              @default(0) @map("claimed_quantity")
  limitPerUser  Int               @default(1) @map("limit_per_user")
  validFrom     DateTime          @map("valid_from")
  validUntil    DateTime          @map("valid_until")
  isEnabled     Boolean           @default(true) @map("is_enabled")
  createdAt     DateTime          @default(now()) @map("created_at")
  updatedAt     DateTime          @updatedAt @map("updated_at")

  // 关联关系
  userCoupons UserCoupon[] @relation("CouponUsers")
  orderCoupons OrderCoupon[] @relation("CouponOrders")

  @@index([isEnabled])
  @@index([validFrom, validUntil])
  @@map("coupons")
}

// 8. 用户优惠券表 (user_coupons)
model UserCoupon {
  id         Int              @id @default(autoincrement())
  userId     Int              @map("user_id")
  couponId   Int              @map("coupon_id")
  status     UserCouponStatus @default(AVAILABLE) @map("status")
  usedAt     DateTime?        @map("used_at")
  expiresAt  DateTime         @map("expires_at")
  createdAt DateTime         @default(now()) @map("created_at")

  // 关联关系
  user   User   @relation("UserCoupons", fields: [userId], references: [id])
  coupon Coupon @relation("CouponUsers", fields: [couponId], references: [id])

  @@unique([userId, couponId])
  @@index([userId])
  @@index([couponId])
  @@index([status])
  @@map("user_coupons")
}

// 9. 订单优惠券关联表 (order_coupons)
model OrderCoupon {
  id        Int     @id @default(autoincrement())
  orderId   Int     @map("order_id")
  couponId  Int     @map("coupon_id")
  discount  Decimal @db.Decimal(10, 2) @map("discount")
  createdAt DateTime @default(now()) @map("created_at")

  // 关联关系
  order  Order  @relation("OrderCoupons", fields: [orderId], references: [id])
  coupon Coupon @relation("CouponOrders", fields: [couponId], references: [id])

  @@unique([orderId, couponId])
  @@index([orderId])
  @@index([couponId])
  @@map("order_coupons")
}

// 10. 评价表 (reviews)
model Review {
  id         Int         @id @default(autoincrement())
  orderId    Int         @map("order_id")
  userId     Int         @map("user_id")
  productId  Int         @map("product_id")
  rating     Int         @map("rating") // 1-5 星评分
  content    String?     @db.Text @map("content")
  images     String[]    @default([]) @map("images") // 评价图片
  isAnonymous Boolean   @default(false) @map("is_anonymous") // 是否匿名
  status     ReviewStatus @default(PENDING) @map("status") // 审核状态
  adminReply String?     @db.Text @map("admin_reply") // 管理员回复
  repliedAt  DateTime?   @map("replied_at")
  createdAt  DateTime    @default(now()) @map("created_at")
  updatedAt  DateTime    @updatedAt @map("updated_at")

  // 关联关系
  user    User    @relation("UserReviews", fields: [userId], references: [id])
  product Product @relation("ProductReviews", fields: [productId], references: [id])
  order   Order   @relation("OrderReview", fields: [orderId], references: [id])

  @@unique([orderId, productId]) // 每个订单产品只能评价一次
  @@index([userId])
  @@index([productId])
  @@index([orderId])
  @@index([status])
  @@index([rating])
  @@map("reviews")
}

// 11. 轮播图表 (banners)
model Banner {
  id          Int      @id @default(autoincrement())
  title       String   @map("title")
  imageUrl    String   @map("image_url")
  linkUrl     String?  @map("link_url")
  linkType    String   @default("none") @map("link_type") // none, product, category, url, mini_program
  productId   Int?     @map("product_id")
  categoryId  Int?     @map("category_id")
  sortOrder   Int      @default(0) @map("sort_order") // 排序，数字越小越靠前
  isEnabled   Boolean  @default(true) @map("is_enabled")
  startDate   DateTime? @map("start_date") // 开始展示时间
  endDate     DateTime? @map("end_date") // 结束展示时间
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // 关联关系
  product  Product?        @relation("BannerProducts", fields: [productId], references: [id])
  category ProductCategory? @relation("BannerCategories", fields: [categoryId], references: [id])

  @@index([isEnabled])
  @@index([sortOrder])
  @@index([startDate, endDate])
  @@map("banners")
}
