<!--pages/products/products.wxml-->
<view class="container">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <image class="search-icon" src="/images/icon_search.png" mode="aspectFit"></image>
      <input
        type="text"
        placeholder="æœç´¢ç ”å­¦äº§å“"
        value="{{keyword}}"
        bindinput="onSearchInput"
        bindconfirm="onSearch"
      />
    </view>
    <button class="search-btn" bindtap="onSearch">æœç´¢</button>
  </view>

  <!-- ç­›é€‰æ  -->
  <view class="filter-bar">
    <view class="filter-item {{sortType === 'default' ? 'active' : ''}}" bindtap="onSort" data-type="default">
      <text>ç»¼åˆ</text>
    </view>
    <view class="filter-item {{sortType === 'sales' ? 'active' : ''}}" bindtap="onSort" data-type="sales">
      <text>é”€é‡</text>
      <text class="icon">â†“</text>
    </view>
    <view class="filter-item {{sortType === 'price' ? 'active' : ''}}" bindtap="onSort" data-type="price">
      <text>ä»·æ ¼</text>
      <text class="icon {{priceOrder === 'asc' ? 'up' : 'down'}}">â†“</text>
    </view>
    <view class="filter-item" bindtap="showFilterPopup">
      <text>ç­›é€‰</text>
      <text class="icon">âš™</text>
    </view>
  </view>

  <!-- åˆ†ç±»æ ‡ç­¾ -->
  <view class="category-tabs" wx:if="{{categories.length > 0}}">
    <scroll-view scroll-x class="tab-scroll">
      <view class="tab-item {{currentCategory === '' ? 'active' : ''}}" bindtap="selectCategory" data-id="">
        å…¨éƒ¨
      </view>
      <view
        class="tab-item {{currentCategory === item.id ? 'active' : ''}}"
        wx:for="{{categories}}"
        wx:key="id"
        bindtap="selectCategory"
        data-id="{{item.id}}"
      >
        {{item.name}}
      </view>
    </scroll-view>
  </view>

  <!-- äº§å“åˆ—è¡¨ -->
  <view class="product-list" wx:if="{{products.length > 0}}">
    <view
      class="product-item"
      wx:for="{{products}}"
      wx:key="id"
      bindtap="goToProduct"
      data-id="{{item.id}}"
    >
      <image class="product-image" src="{{item.coverImage}}" mode="aspectFill"></image>
      <view class="product-info">
        <text class="product-title">{{item.title}}</text>
        <text class="product-desc">{{item.description}}</text>
        <view class="product-tags">
          <text class="tag tag-info" wx:if="{{item.category}}">{{item.category.name}}</text>
          <text class="tag tag-primary" wx:if="{{item.stock > 0}}">æœ‰è´§</text>
          <text class="tag tag-danger" wx:else>å”®ç½„</text>
        </view>
        <view class="product-footer">
          <text class="product-price">Â¥{{item.price}}</text>
          <text class="product-sales">å·²å”®{{item.salesCount || 0}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç©ºçŠ¶æ€ -->
  <view class="empty" wx:else>
    <text class="empty-icon">ğŸ“¦</text>
    <text>æš‚æ— äº§å“</text>
  </view>

  <!-- åŠ è½½æ›´å¤š -->
  <view class="load-more" wx:if="{{hasMore}}">
    <text wx:if="{{!loading}}">ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    <text wx:else>åŠ è½½ä¸­...</text>
  </view>

  <!-- æ²¡æœ‰æ›´å¤š -->
  <view class="no-more" wx:if="{{!hasMore && products.length > 0}}">
    <text>æ²¡æœ‰æ›´å¤šäº†</text>
  </view>
</view>

<!-- ç­›é€‰å¼¹çª— -->
<view class="filter-popup {{showPopup ? 'show' : ''}}" bindtap="hideFilterPopup">
  <view class="popup-content" catchtap="stopPropagation">
    <view class="popup-header">
      <text class="popup-title">ç­›é€‰</text>
      <text class="popup-close" bindtap="hideFilterPopup">âœ•</text>
    </view>
    <view class="popup-body">
      <view class="filter-group">
        <text class="filter-label">ä»·æ ¼åŒºé—´</text>
        <view class="price-range">
          <input type="number" placeholder="æœ€ä½ä»·" value="{{minPrice}}" bindinput="onMinPriceInput" />
          <text class="separator">-</text>
          <input type="number" placeholder="æœ€é«˜ä»·" value="{{maxPrice}}" bindinput="onMaxPriceInput" />
        </view>
      </view>
      <view class="filter-group">
        <text class="filter-label">åº“å­˜çŠ¶æ€</text>
        <view class="stock-options">
          <label class="option">
            <checkbox value="inStock" checked="{{stockFilter.inStock}}" bindtap="toggleStock" data-type="inStock" />
            <text>æœ‰è´§</text>
          </label>
          <label class="option">
            <checkbox value="outOfStock" checked="{{stockFilter.outOfStock}}" bindtap="toggleStock" data-type="outOfStock" />
            <text>å”®ç½„</text>
          </label>
        </view>
      </view>
    </view>
    <view class="popup-footer">
      <button class="btn-reset" bindtap="resetFilter">é‡ç½®</button>
      <button class="btn-confirm" bindtap="applyFilter">ç¡®å®š</button>
    </view>
  </view>
</view>
