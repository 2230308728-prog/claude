<!--pages/product/product.wxml-->
<view class="container" wx:if="{{product}}">
  <!-- 产品图片 -->
  <view class="product-images">
    <swiper
      indicator-dots="{{true}}"
      autoplay="{{false}}"
      circular="{{true}}"
      bindchange="onImageChange"
    >
      <swiper-item wx:for="{{product.images}}" wx:key="index">
        <image class="product-image" src="{{item}}" mode="aspectFill"></image>
      </swiper-item>
    </swiper>
  </view>

  <!-- 产品基本信息 -->
  <view class="product-info">
    <view class="product-header">
      <text class="product-title">{{product.title}}</text>
      <view class="product-tags">
        <text class="tag tag-info" wx:if="{{product.category}}">{{product.category.name}}</text>
        <text class="tag tag-primary" wx:if="{{product.stock > 0}}">有货</text>
        <text class="tag tag-danger" wx:else>售罄</text>
      </view>
    </view>

    <view class="product-price-row">
      <text class="product-price">¥{{product.price}}</text>
      <text class="original-price" wx:if="{{product.originalPrice && product.originalPrice > product.price}}">
        ¥{{product.originalPrice}}
      </text>
      <text class="product-sales">已售{{product.salesCount || 0}}</text>
    </view>

    <view class="product-stock" wx:if="{{product.stock > 0}}">
      <text>库存：{{product.stock}}</text>
    </view>
  </view>

  <!-- 产品详情 -->
  <view class="product-detail">
    <view class="detail-header">
      <text class="detail-title">产品详情</text>
    </view>
    <view class="detail-content">
      <text class="detail-desc">{{product.description}}</text>

      <!-- 详细信息 -->
      <view class="detail-info">
        <view class="info-row" wx:if="{{product.duration}}">
          <text class="info-label">活动时长：</text>
          <text class="info-value">{{product.duration}}</text>
        </view>
        <view class="info-row" wx:if="{{product.location}}">
          <text class="info-label">活动地点：</text>
          <text class="info-value">{{product.location}}</text>
        </view>
        <view class="info-row" wx:if="{{product.ageRange}}">
          <text class="info-label">适合年龄：</text>
          <text class="info-value">{{product.ageRange}}</text>
        </view>
        <view class="info-row" wx:if="{{product.difficulty}}">
          <text class="info-label">难度等级：</text>
          <text class="info-value">{{product.difficulty}}</text>
        </view>
      </view>

      <!-- 行程安排 -->
      <view class="itinerary" wx:if="{{product.itinerary && product.itinerary.length > 0}}">
        <text class="section-title">行程安排</text>
        <view class="itinerary-item" wx:for="{{product.itinerary}}" wx:key="index">
          <view class="itinerary-time">{{item.time}}</view>
          <view class="itinerary-content">{{item.content}}</view>
        </view>
      </view>

      <!-- 费用说明 -->
      <view class="cost-info" wx:if="{{product.costIncluded || product.costExcluded}}">
        <text class="section-title">费用说明</text>
        <view class="cost-item" wx:if="{{product.costIncluded}}">
          <text class="cost-label">费用包含：</text>
          <text class="cost-value">{{product.costIncluded}}</text>
        </view>
        <view class="cost-item" wx:if="{{product.costExcluded}}">
          <text class="cost-label">费用不含：</text>
          <text class="cost-value">{{product.costExcluded}}</text>
        </view>
      </view>

      <!-- 注意事项 -->
      <view class="notice" wx:if="{{product.notice}}">
        <text class="section-title">注意事项</text>
        <text class="notice-content">{{product.notice}}</text>
      </view>
    </view>
  </view>

  <!-- 用户评价 -->
  <view class="reviews-section" wx:if="{{reviewStats}}">
    <view class="section-header">
      <text class="section-title">用户评价</text>
      <view class="rating-summary">
        <text class="rating-score">{{reviewStats.averageRating}}</text>
        <text class="rating-count">/ 5分</text>
        <text class="review-total">{{reviewStats.totalCount}}条评价</text>
      </view>
    </view>

    <!-- 评分分布 -->
    <view class="rating-distribution">
      <view class="rating-item" wx:for="{{[5,4,3,2,1]}}" wx:key="*">
        <view class="star-label">
          <text class="star">{{item}}</text>
          <text class="star-text">星</text>
        </view>
        <view class="rating-bar">
          <view class="rating-fill" style="width: {{reviewStats.totalCount > 0 ? (reviewStats.ratingCounts[item] / reviewStats.totalCount * 100) : 0}}%"></view>
        </view>
        <text class="rating-count">{{reviewStats.ratingCounts[item]}}</text>
      </view>
    </view>

    <!-- 评价列表 -->
    <view class="reviews-list" wx:if="{{reviews.length > 0}}">
      <view class="review-item" wx:for="{{reviews}}" wx:key="id">
        <view class="review-header">
          <view class="reviewer-info">
            <image class="reviewer-avatar" src="{{item.user?.avatarUrl || '/images/default_avatar.png'}}" mode="aspectFill"></image>
            <text class="reviewer-name">{{item.user?.nickname || (item.isAnonymous ? '匿名用户' : '用户')}}</text>
          </view>
          <view class="review-rating">
            <text class="star" wx:for="{{[1,2,3,4,5]}}" wx:key="*" wx:for-item="star" class="{{star <= item.rating ? 'filled' : ''}}">★</text>
          </view>
        </view>
        <view class="review-content">{{item.content}}</view>
        <view class="review-images" wx:if="{{item.images && item.images.length > 0}}">
          <image class="review-image" wx:for="{{item.images}}" wx:key="*"
            src="{{item}}"
            mode="aspectFill"
            bindtap="previewImage"
            data-url="{{item}}"
            data-urls="{{item.images}}"
          ></image>
        </view>
        <view class="review-footer">
          <text class="review-date">{{item.createdAt}}</text>
        </view>
        <view class="admin-reply" wx:if="{{item.adminReply}}">
          <text class="reply-label">商家回复：</text>
          <text class="reply-content">{{item.adminReply}}</text>
        </view>
      </view>
    </view>

    <!-- 查看更多 -->
    <view class="view-more-reviews" wx:if="{{hasMoreReviews}}" bindtap="viewMoreReviews">
      <text>查看全部评价</text>
      <text class="arrow">›</text>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar">
    <view class="bar-left">
      <view class="action-item" bindtap="toggleFavorite">
        <image class="action-icon" src="{{isFavorite ? '/images/icon_heart_active.png' : '/images/icon_heart.png'}}" mode="aspectFit"></image>
        <text class="action-text">收藏</text>
      </view>
      <view class="action-item" bindtap="contactService">
        <image class="action-icon" src="/images/icon_service.png" mode="aspectFit"></image>
        <text class="action-text">客服</text>
      </view>
    </view>
    <view class="bar-right">
      <button class="btn-buy" disabled="{{product.stock === 0}}" bindtap="handleBuy">
        {{product.stock > 0 ? '立即预订' : '已售罄'}}
      </button>
    </view>
  </view>
</view>

<!-- 加载中 -->
<view class="loading-container" wx:if="{{loading}}">
  <text>加载中...</text>
</view>
